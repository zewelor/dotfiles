#!/usr/bin/env zsh

# Minimal Nerd Font installer for Linux.
set -euo pipefail
setopt nullglob

REQUIRED_DEPS=(fc-list fc-cache curl unzip)
FONT_NAME="${1:-}"
USER_FONTS_DIR="$HOME/.local/share/fonts"

has() { command -v "${1:-}" >/dev/null 2>&1; }

check_dependencies() {
  local missing=()
  for dep in "${REQUIRED_DEPS[@]}"; do
    if ! has "$dep"; then
      missing+=("$dep")
    fi
  done

  if (( ${#missing[@]} )); then
    echo "Missing dependencies: ${missing[*]}"
    echo "Install the packages above before running this script."
    exit 1
  fi
}

ensure_font_name() {
  if [[ -z "$FONT_NAME" ]]; then
    echo "Usage: install-font <Nerd Font Name>"
    echo "E.g.: install-font 'Hack'"
    exit 1
  fi
}

show_similar_fonts() {
  local similar
  similar=$(fc-list : family | sort -u | grep -F "$FONT_NAME" || true)
  if [[ -n "$similar" ]]; then
    echo "<--- Fonts similar to \"$FONT_NAME\" already installed: --->"
    echo "$similar"
    return 0
  fi
  return 1
}

download_and_install_font() {
  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf "$temp_dir"' EXIT

  local download_url="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/${FONT_NAME}.zip"
  echo "<--- Downloading $FONT_NAME ... --->"
  curl -L -o "$temp_dir/font.zip" "$download_url"
  unzip -q "$temp_dir/font.zip" -d "$temp_dir"

  mkdir -p "$USER_FONTS_DIR"
  for candidate in "$temp_dir"/*.{otf,ttf,woff,woff2,eot,svg}; do
    [[ -e "$candidate" ]] || continue
    mv "$candidate" "$USER_FONTS_DIR/"
  done

  fc-cache -fv "$USER_FONTS_DIR"
  echo "<--- $FONT_NAME installed to $USER_FONTS_DIR --->"
}

main() {
  check_dependencies
  ensure_font_name

  if show_similar_fonts; then
    read -r "response?Install $FONT_NAME anyway? [y/N] "
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "<--- Installation of $FONT_NAME cancelled --->"
      exit 0
    fi
  fi

  download_and_install_font
}

main
